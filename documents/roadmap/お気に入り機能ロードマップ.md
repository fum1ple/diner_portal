# Day 8: お気に入り機能 実装 (BE & FE) と 結合テスト
6/11 担当：阿野
## 1日の目標:

* お気に入り機能のバックエンドAPI（登録・解除・一覧取得）をすべて実装する。
* 店舗詳細APIを改修し、ユーザーがお気に入り済みかどうかの情報を含める。
* フロントエンドでお気に入りボタンと、お気に入り一覧ページを実装し、APIと連携させる。
* 実装した機能を含め、全体的な結合テストとバグ修正を行う。

---

## 午前 (約3.5時間): お気に入り機能バックエンド (BE) 実装

**タスク 8.1: 【DB・モデル】Favorite モデル作成・マイグレーション・関連付け (約0.75時間)**

* 🎯 **ゴール**: `Favorite`テーブルを作成し、`User`および`Restaurant`モデルとの関連（多対多）を設定する。
* **担当目安**: 2年目の方。
* **実装タスク (Ruby on Rails)**:
    1.  モデルを生成する: `rails g model Favorite user:references restaurant:references`
    2.  生成されたマイグレーションファイルに、複合ユニークインデックスを追加する: `add_index :favorites, [:user_id, :restaurant_id], unique: true`
    3.  マイグレーションを実行する: `rails db:migrate`
    4.  `User` モデルに下記を追加する:
        ```ruby
        has_many :favorites, dependent: :destroy
        has_many :favorite_restaurants, through: :favorites, source: :restaurant
        ```
    5.  `Restaurant` モデルに下記を追加する:
        ```ruby
        has_many :favorites, dependent: :destroy
        has_many :favoriting_users, through: :favorites, source: :user
        ```

**タスク 8.2: 【BE】お気に入り登録/解除API実装 (約1.5時間)**

* 🎯 **ゴール**: 認証ユーザーが特定の店舗をお気に入り登録・解除できるようにするAPIロジックを実装する。
* **担当目安**: 2年目の方主導、2ヶ月目の方サポート。
* **実装タスク (Ruby on Rails)**:
    1.  `config/routes.rb` にネストした単数形リソースのルーティングを設定する:
        ```ruby
        namespace :api do
          resources :restaurants, only: [] do
            resource :favorite, only: [:create, :destroy], controller: 'favorites'
          end
          resources :favorites, only: [:index] # 一覧取得用
        end
        ```
    2.  `app/controllers/api/favorites_controller.rb` を作成する。
    3.  `create` アクションを実装する: `current_user.favorites.create!(restaurant_id: params[:restaurant_id])` を使い、成功時はステータス `201 Created`、失敗時（既に存在する場合など）は適切なエラーを返す。
    4.  `destroy` アクションを実装する: `favorite = current_user.favorites.find_by!(restaurant_id: params[:restaurant_id])` で探し、`favorite.destroy!` で削除。成功時はステータス `204 No Content`、見つからない場合は `404 Not Found` を返す。
    5.  コントローラ全体で認証を必須とする: `before_action :authenticate_user!`

**タスク 8.3: 【BE】お気に入り一覧取得API実装 (約0.75時間)**

* 🎯 **ゴール**: 認証ユーザーがお気に入り登録した店舗の一覧を取得できるAPIロジックを実装する。
* **担当目安**: 2ヶ月目の方挑戦、2年目の方サポート。
* **実装タスク (Ruby on Rails)**:
    1.  `Api::FavoritesController` に `index` アクションを追加する。
    2.  `current_user.favorite_restaurants.includes(:area_tag, :genre_tag).order(created_at: :desc)` でお気に入り店舗一覧を取得する。
    3.  店舗一覧APIと同様の形式（店舗情報）でJSONを返す。

**タスク 8.4: 【BE改修】店舗詳細APIに `is_favorited` フラグを追加 (約0.5時間)**

* 🎯 **ゴール**: 店舗詳細API (`GET /api/restaurants/:id`) のレスポンスに、現在のユーザーがお気に入り済みかを示すフラグを追加する。
* **担当目安**: 2年目の方。
* **実装タスク (Ruby on Rails)**:
    1.  `RestaurantsController#show` アクションで、レスポンスを整形する `restaurant_response` メソッドなどを修正する。
    2.  `is_favorited: current_user&.favorites&.exists?(restaurant_id: @restaurant.id)` のようなロジックでフラグを計算し、JSONレスポンスに含める。`current_user`が`nil`の場合も考慮すること。

---

## 午後 (約3.5時間): お気に入り機能フロントエンド (FE) 実装

**タスク 8.5: 【FE】お気に入りボタンUIコンポーネントとAPI連携 (約1.5時間)**

* 🎯 **ゴール**: 店舗詳細ページにお気に入りボタンを設置し、APIと連携させてリアルタイムに表示を更新する。
* **担当目安**: 2ヶ月目の方主担当、2年目の方サポート。
* **実装タスク (Next.js & Copilot指示用)**:
    * `restaurant` オブジェクトをpropsで受け取る `<FavoriteButton restaurant={restaurant} />` のようなコンポーネントを作成してください。
    * `restaurant` オブジェクトに含まれる `is_favorited` フラグを元に、お気に入り状態の初期値を `useState` で設定してください。
    * ボタンがクリックされたら、現在の状態に応じて `POST` または `DELETE` のリクエストを `/api/restaurants/:restaurantId/favorite` に送信する非同期関数を実装してください。
    * APIリクエストの成功後、`useState` のセッター関数を呼び出してボタンの表示状態を更新してください（オプティミスティックUI）。
    * ハートアイコンなどを使用し、お気に入り状態に応じて色が変わるようにスタイリングしてください。

**タスク 8.6: 【FE】お気に入り一覧ページ作成とAPI連携 (約1.5時間)**

* 🎯 **ゴール**: 認証ユーザーがお気に入り登録した店舗の一覧を表示する専用ページ (`/favorites`) を作成する。
* **担当目安**: 2年目の方主導、2ヶ月目の方サポート。
* **実装タスク (Next.js & Copilot指示用)**:
    * Next.jsで `/favorites` という新しいページを作成してください。
    * ページがマウントされたら `useEffect` 内でお気に入り一覧API (`GET /api/favorites`) を呼び出し、取得した店舗データを `useState` で管理してください。
    * ローディング中・エラー・お気に入り0件の場合の表示もそれぞれ実装してください。
    * 取得したデータをマップし、既存の店舗カードコンポーネントを再利用して一覧表示してください。

**タスク 8.7: 【テスト】BE/FE結合 手動テスト (約0.5時間)**

* 🎯 **ゴール**: 実装したお気に入り機能がBE・FE連携して正しく動作することを確認する。
* **担当目安**: 2人。
* **内容**:
    * Postmanでお気に入りBE API（登録・解除・一覧）が一通り動作することを確認。
    * ブラウザで店舗詳細ページを開き、お気に入りボタンが初期状態で正しく表示されるか、クリックで登録・解除ができて表示も変わるか確認。
    * お気に入り一覧ページが正しく表示されるか確認。

---

## 夕方 (約1時間): 全体テストとDay8完了確認

**タスク 8.8: 【テスト】全体結合テストとバグ修正 (約1時間)**

* 🎯 **ゴール**: 主要なユーザーストーリーが問題なく動作することを確認し、発見したバグを修正する。
* **担当目安**: ペアプログラミング推奨。
* **内容**:
    * Day8のタスクリストで提示した「基本フロー」と「エッジケース」のシナリオを元に、アプリケーション全体を一通り操作する。
    * 発見したバグや表示崩れを記録し、優先度の高いものから修正する。
    * 本日の実装・テスト状況、未修正のバグをチームで共有する。