# 🏪 店舗管理機能ロードマップ

## 📋 機能概要
TOKIEATSの店舗管理機能は、社員が発見したレストランを登録・管理し、レビューと評価を通じて情報を共有できるシステムです。

### 主要機能
- 店舗の新規登録・編集・削除
- 店舗一覧表示（写真、タグ、評価表示）
- 店舗詳細表示（レビュー、集計タグ、価格帯）
- 画像管理・レビューシステム連携

---

### Phase 1: コアバックエンド基盤構築とAPI開発 (最優先 - MUST)

**目的:** アプリケーションの根幹となるデータ構造と主要APIを整備し、構築済みのフロントエンド認証機能と連携可能にする。

* **Phase 1A: データモデルとマイグレーション (Ruby on Rails)**
    * ✅ **User** モデル: **既存完了** - Google認証に必要な情報（`name`, `email`, `google_id`）は実装済み
    * **Tag** モデル: タグ情報（`name`, `category` - カテゴリ例: genre, scene, time, price, area）
    * **Restaurant** モデル: 基本店舗情報（`name`, `user_id` (登録者), `description`, `address` (オプション), `area_tag_id` (TagへのFK)）
    * **Review** モデル: レビュー情報（`user_id`, `restaurant_id`, `comment`, `rating`, `visit_date`, `meal_time`, `party_size`, `price_range`）
    * **ReviewImage** モデル: レビュー画像（`review_id`, `image_url` - Reviewへの1:N関連）
    * **ReviewTag** モデル: レビューとタグの中間テーブル（`review_id`, `tag_id`）
    * **Favorite** モデル: お気に入り情報（`user_id`, `restaurant_id`）
    * **Active Storage設定**: `Restaurant`の代表写真（`has_one_attached :main_image`）、`ReviewImage`の複数画像（`has_many_attached :images`）
* **Phase 1B: コアAPI開発 (Ruby on Rails)**
    * ✅ **ユーザー認証API**: **既存完了** - JWT認証システム (`/api/auth/google`, `/api/auth/refresh`, `/api/user/profile`) は実装済み
    * **Tag API**: 
        - `GET /api/tags` - 全タグ一覧取得（カテゴリ別フィルタ対応）
        - `GET /api/tags/:category` - カテゴリ別タグ取得
        - `POST /api/tags` - タグ作成
        - **初期タグデータ**: seeds.rbでエリア、ジャンル、シーン、時間帯、価格帯、人数区分を投入
    * **Restaurant API**: 
        - `GET /api/restaurants` - 店舗一覧取得（ページネーション、フィルタリング対応）
        - `GET /api/restaurants/:id` - 店舗詳細取得
        - `POST /api/restaurants` - 店舗新規作成（認証必須）
        - `PUT /api/restaurants/:id` - 店舗情報更新
        - `DELETE /api/restaurants/:id` - 店舗削除
    * **Review API**: 
        - `GET /api/restaurants/:restaurant_id/reviews` - 特定店舗のレビュー一覧
        - `POST /api/restaurants/:restaurant_id/reviews` - レビュー作成（認証必須）
        - `PUT /api/reviews/:id` - レビュー更新
        - `DELETE /api/reviews/:id` - レビュー削除
        - **画像アップロード**: Active Storage経由での複数画像対応
    * **Favorite API**: 
        - `GET /api/user/favorites` - ユーザーのお気に入り一覧
        - `POST /api/restaurants/:restaurant_id/favorite` - お気に入り登録
        - `DELETE /api/restaurants/:restaurant_id/favorite` - お気に入り解除
* **Phase 1C: フロントエンド基盤連携準備 (Next.js)**
    * **現状**: Google認証機能、基本的な画面レイアウト（ヘッダーでのユーザー情報表示等）は構築済み。
    * **タスク**:
        * バックエンドAPI（Phase 1Bで開発）との認証連携の最終調整。
        * 今後開発する認証必須ページのためのルーティングガード/リダイレクト処理の整備。
        * （必要に応じて）UIコンポーネントライブラリが未導入の場合、選定と基本導入。

---

### Phase 2: 店舗とレビューの基本機能実装 (高優先度 - MUST)

**目的:** ユーザーが店舗情報を閲覧し、レビューを投稿・閲覧できるコアな体験を提供する。

* **Phase 2A: 店舗一覧・詳細表示機能 (Next.js)**
    * **店舗一覧ページ (`/restaurants`)**:
        * 登録されている店舗をカード形式などで表示（店舗名、代表写真、エリアタグ）。
        * ページネーション機能。
    * **店舗詳細ページ (`/restaurants/:id`)**:
        * 店舗基本情報表示（店舗名、代表写真、エリアタグ）。
        * 当該店舗のレビュー一覧表示（レビュー本文、★評価、投稿ユーザー名、レビュー写真サムネイル）。
* **Phase 2B: レビュー投稿・表示機能 (Next.js)**
    * **レビュー投稿フォーム**:
        * コメント入力、★評価選択。
        * 複数画像アップロード機能（プレビュー、枚数制限など）。
        * タグ選択機能（ジャンル、シーン、時間帯、価格帯、人数 - Phase 1Bで用意したTagマスタから選択）。
    * **レビュー詳細表示**:
        * 店舗詳細ページ内のレビュー一覧で、各レビューの画像をクリックすると拡大表示（簡易的なライトボックス機能）。
* **Phase 2C: 店舗登録・編集機能 (Next.js)**
    * **店舗新規登録ページ (`/restaurants/new`)**:
        * 店舗名入力、代表写真アップロード（1枚必須）、エリアタグ選択（Tagマスタから）。
    * **店舗編集・削除機能**:
        * 登録者のみが編集・削除可能。
        * 編集ページでは既存情報をフォームに表示。
        * 削除時の確認ダイアログ。

---

### Phase 3: タグ集計表示と検索・絞り込み機能 (中優先度 - MUST)

**目的:** レビュー情報を活用した付加価値の高い情報を提供し、目的の店舗を見つけやすくする。

* **Phase 3A: タグ集計バックエンド処理 (Ruby on Rails)**
    * **RestaurantTagSummary** モデルと関連ロジック:
        * レビュー投稿・編集・削除時に、関連する店舗の集計タグ情報（ジャンル、シーン、時間帯、価格帯、人数など各タグの出現回数）を更新する処理。
    * **店舗詳細情報API拡張**:
        * `RestaurantTagSummary` から集計されたタグ情報（各タグとそのカウント）を含めて返す。
        * レビュー写真一覧を返す（店舗詳細上部のスライドショー用）。
* **Phase 3B: 店舗詳細・一覧の表示拡充 (Next.js)**
    * **店舗詳細ページ**:
        * レビューから集計された各種タグを表示（例: 人気のジャンルタグ、シーンタグなど）。
        * レビュー写真スライドをページ上部に表示。
        * 昼・夜別の価格帯を表示（時間帯タグと価格帯タグの集計結果から最頻値を算出・表示）。
    * **店舗一覧ページ**:
        * （オプション）店舗カードに代表的な集計ジャンルタグなどを表示検討。
* **Phase 3C: 基本的な検索・絞り込み機能 (Ruby on Rails & Next.js)**
    * **バックエンド (API拡張)**:
        * 店舗名による検索API。
        * エリアタグ、およびレビュー集計による主要タグ（ジャンル、シーン、時間帯、価格帯など）での絞り込みAPI。
    * **フロントエンド (UI実装)**:
        * 店舗一覧ページに検索ボックス（店舗名）を設置。
        * サイドバーなどに絞り込みオプション（エリアタグ、ジャンルタグ等）を設置。

---

### Phase 4: ユーザー体験向上とWANT機能の実装 (中～低優先度)

**目的:** お気に入り機能の拡充、WANT機能の追加、全体的なUI/UXの向上。

* **Phase 4A: お気に入り機能とUI改善 (Next.js)**
    * **お気に入り機能**:
        * 店舗一覧や詳細ページに「お気に入り登録/解除」ボタンを設置。
        * ユーザーごとのお気に入り店舗一覧ページ作成。
    * **UI改善**:
        * 「Google Mapで調べる」ボタンを店舗詳細に表示（店舗名をクエリとしてGoogle Maps検索へ遷移）。
        * レスポンシブデザインの徹底と全体的な操作性・視認性の向上。
* **Phase 4B: WANT機能 - 閲覧履歴とレビューへの「いいね」 (Ruby on Rails & Next.js)**
    * **閲覧履歴機能 (WANT)**:
        * **Backend**: `History` モデル作成、店舗閲覧時に履歴を記録するAPI。
        * **Frontend**: ユーザーごとの閲覧履歴一覧ページ作成（直近閲覧順）。
    * **レビューへの「いいね」機能 (WANT)**:
        * **Backend**: `ReviewLike` モデル作成、レビューへの「いいね」登録/解除API。
        * **Frontend**: 各レビューに「いいね」ボタンと件数を表示。
* **Phase 4C: 高度な機能と運用準備 (低優先度 - 将来検討)**
    * **ランキング・傾向分析機能**:
        * 閲覧数、お気に入り数、レビュー数などに基づくランキング表示（週間、月間など）。
        * （要件に応じて）おすすめ店舗表示ロジック検討。
    * **管理者機能**:
        * 必要に応じてタグの管理画面（CRUD）。
        * （要件に応じて）ユーザー管理、店舗管理、不適切レビュー管理など。
    * **パフォーマンステストと最適化**:
        * データ量増加を見越したパフォーマンス確認と改善。
    * **最終テストとデプロイ準備**:
        * 総合テスト、セキュリティチェック、本番環境へのデプロイ準備。

---
### 各Phaseの主な完了イメージと推奨スケジュール

* **Phase 1完了時（目標: 6月10日）**: バックエンドのコアAPI群が完成し、構築済みのフロントエンド認証基盤と連携できる状態。
  - データモデル完成、基本API動作確認済み
  - 店舗・レビューの基本CRUD操作が可能

* **Phase 2完了時（目標: 6月17日）**: ユーザーは店舗の情報を閲覧し、写真やタグ付きでレビューを投稿・編集・削除できる。店舗の新規登録も可能。
  - フロントエンド基本機能完成
  - 画像アップロード機能動作確認済み

* **Phase 3完了時（目標: 6月24日）**: 店舗詳細ページでレビューに基づいた集計タグ（人気ジャンルや価格帯など）が表示される。店舗名やタグでの検索・絞り込みが可能。
  - 集計機能・検索機能完成
  - ユーザビリティ向上

* **Phase 4完了時（目標: 7月1日）**: お気に入り機能が利用可能。レスポンシブ対応が完了し、全体的なUXが向上。（WANT機能が実装されていれば）閲覧履歴やレビューへの「いいね」も利用可能。
  - 付加価値機能完成
  - 本番運用準備完了

### 🚨 **重要な前提条件**
1. **認証システム**: 既存のJWT認証システム（✅完了）を活用
2. **データベース**: 現在のPostgreSQL環境を使用
3. **画像処理**: `image_processing` gem（✅有効化済み）
4. **開発環境**: Docker compose環境での開発継続

---

### 📋 技術的考慮事項・制約

#### **Active Storage 画像管理**
- **規模上限**: 店舗数500-1,000、総画像数10,000-30,000枚程度まで対応可能
- **推奨制限**: 
  - 代表画像: 5MB以下、2000x2000px以内
  - レビュー画像: 3MB以下、1枚のレビューあたり最大5枚
  - 対応形式: JPEG, PNG, WebP
- **必要な設定**:
  - `image_processing` gem の有効化（✅完了）
  - 画像バリアント生成（サムネイル、中サイズ等）
  - ストレージ設定（本番環境ではS3等への移行推奨）

#### **データベース設計の注意点**
- **パフォーマンス**: レビュー数増加に伴うN+1問題対策（includes等）
- **インデックス**: 検索・絞り込み用のインデックス設計
- **集計処理**: `RestaurantTagSummary` のリアルタイム更新戦略

#### **セキュリティ考慮事項**
- **画像アップロード**: ファイル形式・サイズ制限、マルウェアスキャン
- **認証・認可**: 既存JWT認証システムとの適切な連携
- **入力値検証**: XSS対策、SQL injection対策

---
