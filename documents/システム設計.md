# システム設計

# アーキテクチャ選定

このシステムは、**フロントエンドにNext.js（Reactベースのフレームワーク）**を、**バックエンドにRuby on Rails（APIモード）**を使用する構成です。
Next.jsはユーザーに見える画面部分（UI）を担当し、Railsはデータベースとのやり取りや業務ロジックを処理するAPIを提供します。両者はHTTP（通常はJSON形式）で通信する、
いわゆる**「ヘッドレスアーキテクチャ」**です。

# コンテナ図

- クライアント：Webブラウザ（PC / スマートフォン）
- フロントエンド：Next.js（TypeScript）
- バックエンド：Ruby on Rails
- データベース：PostgreSQL
- 開発環境：GitHub Codespaces/ローカル
- デプロイ環境：Render
- コンテナ管理：Docker / Docker Compose

# エンティティ一覧

| **エンティティ名** | **説明** |
| --- | --- |
| User | 利用者情報 (User Information) |
| Restaurant | 店舗情報 (Restaurant Information) |
| Review | レビュー情報 (Review Information) |
| ReviewImage | レビュー画像 (Review Images) |
| Tag | タグ情報（ジャンル、シーンなど）(Tag Information) |
| ReviewTag | レビューとタグの中間テーブル (Review-Tag Junction) |
| RestaurantTagSummary | 店舗ごとのタグ集計 (Restaurant Tag Summary) |
| Favorite (WANT) | お気に入り情報 (Favorite Information) |
| History (WANT) | 閲覧履歴情報 (Browse History) |
| ReviewLike (WANT) | レビューいいね情報 (Review Likes) |

# リレーション

- ユーザー関連
    - User `1 : N` Review - ユーザーは複数のレビューを投稿可能
    - User `1 : N` Favorite - ユーザーは複数の店舗をお気に入り登録可能
    - User `1 : N` History - ユーザーは複数の閲覧履歴を持つ
    - User `1 : N` ReviewLike - ユーザーは複数のレビューにいいね可能
- 店舗関連
    - Restaurant `1 : N` Review - 店舗には複数のレビューが紐づく
    - Restaurant `1 : N` Favorite - 店舗は複数のユーザーにお気に入り登録される
    - Restaurant `1 : N` History - 店舗は複数のユーザーに閲覧される
    - Restaurant `1 : N` RestaurantTagSummary - 店舗は複数の集計タグを持つ
- レビュー関連
    - Review `1 : N` ReviewImage - レビューには複数の画像を添付可能
    - Review `N : N` Tag (via ReviewTag) - レビューと複数のタグを紐づけ
    - Review `1 : N` ReviewLike - レビューは複数のいいねを受け取る
- タグ関連
    - Tag `1 : N` ReviewTag - タグは複数のレビューと紐づく
    - Tag `1 : N` RestaurantTagSummary - タグは複数の店舗集計と紐づく

# コンポーネント図

### フロントエンド

- ページコンポーネント
    - 店舗一覧
    - 店舗詳細
    - レビュー投稿
    - 検索結果
    - ランキング　などなど
- UIコンポーネント
    - ヘッダー
    - サイドバー
    - カード
    - モーダル
    - フォーム　などなど
- 状態管理
    - 未定
- ルーティング
    - Next.js App Router

### バックエンド

- コントローラー
    - UsersController
    - RestaurantsController
    - ReviewsController
    - TagsController　などなど
- モデル
    - User
    - Restaurant
    - Review
    - Tag
    - Bookmark
    - History　などなど

### データベース

- テーブル
    - users
    - restaurants
    - reviews
    - tags
    - bookmarks
    - histories　などなど

## テーブル設計

### Usersテーブル

| **カラム名** | **型** | **制約** | **説明 (Description)** |
| --- | --- | --- | --- |
| `id` | INTEGER | PRIMARY KEY | 主キー (Primary Key) |
| `name` | STRING |  | 表示名（Googleの名前） |
| `email` | STRING | NOT NULL, UNIQUE | メールアドレス (Email) |
| `uid` | STRING | NOT NULL, UNIQUE | Googleの一意なID (Google UID) |
| `provider` | STRING | NOT NULL | "google" で固定予定 |
| `icon_url` | STRING |  | プロフィール画像URL |
| `created_at` | DATETIME | NOT NULL | 作成日時 (Creation Time) |
| `updated_at` | DATETIME | NOT NULL | 更新日時 (Update Time) |

### Restaurantテーブル

- **備考**:
- 店舗詳細画面では、その店舗に紐づくレビュー画像（`ReviewImage`）をスライドショー形式で表示することを想定します。
- `image_url` カラムは、主に店舗一覧画面で表示する代表的な画像1枚のURLを保持することを想定します。この画像の選定ロジック（例：最初のレビューの最初の画像、登録者が指定など）はアプリケーション側で定義します。
- 店舗に表示する「昼・夜別の価格帯」や「ランチ・ディナーの有無」は、レビューに付与された時間帯タグ（ランチ/ディナー）と価格帯タグを `RestaurantTagSummary` を介して集計し、アプリケーションロジックまたは表示時のクエリで「適切に判断」して表示することを想定します。

| **カラム名** | **型** | **制約** | **説明 (Description)** |
| --- | --- | --- | --- |
| `id` | INTEGER | PRIMARY KEY | 主キー (Primary Key) |
| `user_id` | INTEGER | NOT NULL, FK (User) | 登録者 (Registrant User ID) |
| `name` | STRING | NOT NULL | 店舗名 (Restaurant Name) |
| `image_url` | STRING | NOT NULL | 店舗代表写真のURL (Main Image URL for list view) |
| `area_tag_id` | INTEGER | FK (Tag) | エリアタグのID (Area Tag ID) |
| `created_at` | DATETIME | NOT NULL | レコード作成日時 (Creation Time) |
| `updated_at` | DATETIME | NOT NULL | レコード更新日時 (Update Time) |

### Reviewテーブル

| **カラム名** | **型** | **制約** | **説明 (Description)** |
| --- | --- | --- | --- |
| `id` | INTEGER | PRIMARY KEY | 主キー (Primary Key) |
| `user_id` | INTEGER | NOT NULL, FK (User) | 投稿者のID (Author User ID) |
| `restaurant_id` | INTEGER | NOT NULL, FK (Restaurant) | 対象店舗のID (Restaurant ID) |
| `comment` | TEXT |  | コメント本文 (Comment Body) |
| `rating` | DECIMAL |  | 評価（例：1〜5）(Rating 1-5) |
| `created_at` | DATETIME | NOT NULL | レコード作成日時 (Creation Time) |
| `updated_at` | DATETIME | NOT NULL | レコード更新日時 (Update Time) |

### ReviewImageテーブル

| **カラム名** | **型** | **制約** | **説明 (Description)** |
| --- | --- | --- | --- |
| `id` | INTEGER | PRIMARY KEY | 主キー (Primary Key) |
| `review_id` | INTEGER | NOT NULL, FK (Review) | 紐づくレビューのID (Review ID) |
| `image_url` | STRING | NOT NULL | 画像のURL (Image URL) |
| `created_at` | DATETIME | NOT NULL | レコード作成日時 (Creation Time) |
| `updated_at` | DATETIME | NOT NULL | レコード更新日時 (Update Time) |

### Tagテーブル

| **カラム名** | **型** | **制約** | **説明 (Description)** |
| --- | --- | --- | --- |
| `id` | INTEGER | PRIMARY KEY | 主キー (Primary Key) |
| `name` | STRING | NOT NULL | タグの表示名（例：寿司、ランチ）(Tag Display Name) |
| `category` | STRING | NOT NULL | タグカテゴリ（例：genre, scene, time, price, area）(Tag Category) |
| `created_at` | DATETIME | NOT NULL | レコード作成日時 (Creation Time) |
| `updated_at` | DATETIME | NOT NULL | レコード更新日時 (Update Time) |

### ReviewTag 中間テーブル

| **カラム名** | **型** | **制約** | **説明 (Description)** |
| --- | --- | --- | --- |
| `id` | INTEGER | PRIMARY KEY | 主キー (Primary Key) |
| `review_id` | INTEGER | NOT NULL, FK (Review) | 外部キー（Reviewテーブルのid）(Review ID) |
| `tag_id` | INTEGER | NOT NULL, FK (Tag) | 外部キー（Tagテーブルのid）(Tag ID) |
| `created_at` | DATETIME | NOT NULL | レコード作成日時 (Creation Time) |
| `updated_at` | DATETIME | NOT NULL | レコード更新日時 (Update Time) |

※ UNIQUE制約：`review_id`と`tag_id`の組み合わせで一意（レビュー内で同一タグは1つまで）

### RestaurantTagSummary　中間テーブル

| **カラム名** | **型** | **制約** | **説明 (Description)** |
| --- | --- | --- | --- |
| `id` | INTEGER | PRIMARY KEY | 主キー (Primary Key) |
| `restaurant_id` | INTEGER | NOT NULL, FK (Restaurant) | 紐づくRestaurantのID (Restaurant ID) |
| `tag_id` | INTEGER | NOT NULL, FK (Tag) | 紐づくTagのID (Tag ID) |
| `count` | INTEGER | NOT NULL, DEFAULT 0 | このタグがこの店舗のレビューで何回付与されたか (Tag Count from Reviews) |
| `created_at` | DATETIME | NOT NULL | レコード作成日時 (Creation Time) |
| `updated_at` | DATETIME | NOT NULL | レコード更新日時 (Update Time) |

※ UNIQUE制約：`restaurant_id`と`tag_id`の組み合わせで一意

### Favorite テーブル　- ✨ WANT 機能

| **カラム名** | **型** | **制約** | **説明 (Description)** |
| --- | --- | --- | --- |
| `id` | INTEGER | PRIMARY KEY | 主キー (Primary Key) |
| `user_id` | INTEGER | NOT NULL, FK (User) | 外部キー（Userテーブルのid）(User ID) |
| `restaurant_id` | INTEGER | NOT NULL, FK (Restaurant) | 外部キー（Restaurantテーブルのid）(Restaurant ID) |
| `created_at` | DATETIME | NOT NULL | レコード作成日時（お気に入り登録日時） |
| `updated_at` | DATETIME | NOT NULL | レコード更新日時 |

※ UNIQUE制約：`user_id`と`restaurant_id`の組み合わせで一意（同じユーザーが同じ店舗を重複してお気に入り登録できない）

### History テーブル - ✨ WANT 機能

※ 備考: 同じユーザーが同じ店舗を再度閲覧した場合は、既存レコードの `viewed_at` を最新の日時に更新する運用（UPSERT）を想定します。これにより、各ユーザーと店舗の組み合わせに対して最新の閲覧履歴のみが保持されます。

| **カラム名** | **型** | **制約** | **説明 (Description)** |
| --- | --- | --- | --- |
| `id` | INTEGER | PRIMARY KEY | 主キー (Primary Key) |
| `user_id` | INTEGER | NOT NULL, FK (User) | 外部キー（Userテーブルのid）(User ID) |
| `restaurant_id` | INTEGER | NOT NULL, FK (Restaurant) | 外部キー（Restaurantテーブルのid）(Restaurant ID) |
| `viewed_at` | DATETIME | NOT NULL | 閲覧日時 (Viewed Time) |

※ UNIQUE制約：`user_id`と`restaurant_id`の組み合わせで一意

### ReviewLike テーブル　- ✨ WANT 機能

| **カラム名** | **型** | **制約** | **説明 (Description)** |
| --- | --- | --- | --- |
| `id` | INTEGER | PRIMARY KEY | 主キー (Primary Key) |
| `user_id` | INTEGER | NOT NULL, FK (User) | 外部キー（Userテーブルのid）(User ID) |
| `review_id` | INTEGER | NOT NULL, FK (Review) | 外部キー（Reviewテーブルのid）(Review ID) |
| `created_at` | DATETIME | NOT NULL | レコード作成日時 (Creation Time) |
| `updated_at` | DATETIME | NOT NULL | レコード更新日時 (Update Time) |

※ UNIQUE制約：`user_id`と`review_id`の組み合わせで一意（同じユーザーが同じレビューを重複していいねできない）